-- =========================
-- route
-- =========================
CREATE TABLE IF NOT EXISTS route (
  id          integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  route_name  text NOT NULL DEFAULT ''
);

-- =========================
-- station
-- =========================
CREATE TABLE IF NOT EXISTS station (
  id          integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name        text NOT NULL DEFAULT '',
  route_id    integer NOT NULL,
  "index"     integer NOT NULL,
  show_style  integer NOT NULL DEFAULT 1,

  CONSTRAINT fk_station_route
    FOREIGN KEY (route_id)
    REFERENCES route(id)
    ON DELETE CASCADE
);

-- (任意) 駅の順序が route 内で一意である方が都合が良いなら
-- CREATE UNIQUE INDEX IF NOT EXISTS ux_station_route_index
--   ON station(route_id, "index");

-- =========================
-- train_type
-- =========================
CREATE TABLE IF NOT EXISTS train_type (
  id          integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  name        text NOT NULL DEFAULT '',
  route_id    integer NOT NULL,
  "index"     integer NOT NULL,
  short_name  text NOT NULL DEFAULT '',
  color       text,                 -- C#側 string? に合わせ NULL 許可
  font_bold   boolean NOT NULL DEFAULT false,
  line_bold   boolean NOT NULL DEFAULT false,
  line_style  integer NOT NULL DEFAULT 0,

  CONSTRAINT fk_train_type_route
    FOREIGN KEY (route_id)
    REFERENCES route(id)
    ON DELETE CASCADE
);

-- EF OnModelCreating: RouteID + Index ユニーク
CREATE UNIQUE INDEX IF NOT EXISTS ux_train_type_route_index
  ON train_type(route_id, "index");

-- =========================
-- trip
-- =========================
CREATE TABLE IF NOT EXISTS trip (
  id            integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  route_id      integer NOT NULL,
  direct        integer NOT NULL DEFAULT 0,
  train_type_id integer NOT NULL DEFAULT 0,
  name          text NOT NULL DEFAULT '',
  no            text NOT NULL DEFAULT '',

  CONSTRAINT fk_trip_route
    FOREIGN KEY (route_id)
    REFERENCES route(id)
    ON DELETE CASCADE,

  CONSTRAINT fk_trip_train_type
    FOREIGN KEY (train_type_id)
    REFERENCES train_type(id)
    ON DELETE RESTRICT
);

-- route内でtripを並べ替える列が今は無いので index は作っていませんが、
-- 取得頻度が高ければ route_id に index は有効です
CREATE INDEX IF NOT EXISTS ix_trip_route_id
  ON trip(route_id);

-- =========================
-- stop_time
-- =========================
CREATE TABLE IF NOT EXISTS stop_time (
  id          bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  trip_id     integer NOT NULL,
  station_id  integer NOT NULL,
  dep_time    integer NOT NULL DEFAULT -1,
  ari_time    integer NOT NULL DEFAULT -1,
  stop_type   integer NOT NULL DEFAULT 0,
  stop        integer NOT NULL DEFAULT 0,

  CONSTRAINT fk_stop_time_trip
    FOREIGN KEY (trip_id)
    REFERENCES trip(id)
    ON DELETE CASCADE,

  CONSTRAINT fk_stop_time_station
    FOREIGN KEY (station_id)
    REFERENCES station(id)
    ON DELETE RESTRICT
);

-- 重要：性能と整合性のために強く推奨
-- 1 trip に対して station は1行だけ、を保証
CREATE UNIQUE INDEX IF NOT EXISTS ux_stop_time_trip_station
  ON stop_time(trip_id, station_id);

-- よく使う検索（Trip→StopTime取得）用
CREATE INDEX IF NOT EXISTS ix_stop_time_trip_id
  ON stop_time(trip_id);

-- (任意) 駅方向の検索が多いなら
-- CREATE INDEX IF NOT EXISTS ix_stop_time_station_id
--   ON stop_time(station_id);